<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wishlist</title>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <meta name="theme-color" content="#0b0f1a">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');

    :root{
      --text:#f2f6ff;
      --muted:rgba(242,246,255,.72);
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius:18px;

      --skyTop:#0b2a4a;
      --skyMid:#123a63;
      --skyLow:#1e5fa3;
      --skyBottom:#5fa9e6;

      --panel: rgba(10,30,55,.75);
      --panel2: rgba(255,255,255,.06);
      --stroke: rgba(160,210,255,.18);

      --accent1:#1e78c8;
      --accent2:#9fd4ff;

      --chipBg: rgba(255,255,255,.06);
      --chipStroke: rgba(255,255,255,.10);

      --btnBg: rgba(255,255,255,.08);
      --btnStroke: rgba(255,255,255,.12);

      --dangerBg: rgba(255,92,108,.14);
      --dangerStroke: rgba(255,92,108,.25);

      --prioStroke: rgba(255,204,102,.45);
      --prioGlow: rgba(255,204,102,.22);
      --prioBg: rgba(255,204,102,.10);
      --prioText: rgba(255,235,190,.95);

      --link: rgba(37,205,255,.95);
      --linkStroke: rgba(37,205,255,.25);
      --linkBg: rgba(37,205,255,.08);
    }

    [data-theme="night"]{
      --text:#eef3ff;
      --muted:rgba(238,243,255,.75);

      --skyTop:#040712;
      --skyMid:#061226;
      --skyLow:#071e39;
      --skyBottom:#0a2c4a;

      --panel: rgba(6,14,28,.80);
      --panel2: rgba(255,255,255,.05);
      --stroke: rgba(140,190,255,.14);

      --accent1:#0f6fbf;
      --accent2:#7fc6ff;

      --chipBg: rgba(255,255,255,.05);
      --chipStroke: rgba(255,255,255,.08);

      --btnBg: rgba(255,255,255,.07);
      --btnStroke: rgba(255,255,255,.10);

      --dangerBg: rgba(255,92,108,.12);
      --dangerStroke: rgba(255,92,108,.22);

      --link: rgba(120,210,255,.95);
      --linkStroke: rgba(120,210,255,.22);
      --linkBg: rgba(120,210,255,.07);
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      color:var(--text);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: linear-gradient(to bottom,
        var(--skyTop) 0%,
        var(--skyMid) 35%,
        var(--skyLow) 60%,
        var(--skyBottom) 100%
      );
      background-attachment: fixed;
      overflow-x:hidden;
    }

    body::before{
      content:"";
      position:fixed;
      inset:-55%;
      background:
        radial-gradient(1200px 460px at 18% 18%, rgba(255,255,255,.12), transparent 65%),
        radial-gradient(1100px 420px at 70% 22%, rgba(255,255,255,.10), transparent 66%),
        radial-gradient(1300px 520px at 45% 48%, rgba(255,255,255,.09), transparent 70%),
        radial-gradient(1200px 460px at 25% 70%, rgba(255,255,255,.08), transparent 70%),
        radial-gradient(1400px 540px at 78% 74%, rgba(255,255,255,.08), transparent 70%),

        radial-gradient(900px 360px at 8% 40%, rgba(255,255,255,.07), transparent 70%),
        radial-gradient(980px 380px at 92% 52%, rgba(255,255,255,.07), transparent 70%),
        radial-gradient(1000px 400px at 55% 10%, rgba(255,255,255,.06), transparent 70%),
        radial-gradient(1050px 420px at 52% 92%, rgba(255,255,255,.06), transparent 70%),
        radial-gradient(950px 360px at 35% 30%, rgba(255,255,255,.06), transparent 70%);
      pointer-events:none;
      opacity:.95;
      transform: translate3d(0,0,0);
      animation: cloudDrift1 40s linear infinite;
      filter: blur(0.2px);
    }

    body::after{
      content:"";
      position:fixed;
      inset:-60%;
      background:
        radial-gradient(1400px 560px at 12% 30%, rgba(255,255,255,.08), transparent 72%),
        radial-gradient(1500px 600px at 82% 35%, rgba(255,255,255,.07), transparent 72%),
        radial-gradient(1350px 520px at 58% 62%, rgba(255,255,255,.06), transparent 74%),
        radial-gradient(1250px 500px at 28% 88%, rgba(255,255,255,.06), transparent 74%),

        radial-gradient(1000px 420px at 40% 38%, rgba(255,255,255,.05), transparent 75%),
        radial-gradient(980px 400px at 65% 18%, rgba(255,255,255,.05), transparent 75%),
        radial-gradient(980px 400px at 15% 60%, rgba(255,255,255,.05), transparent 75%),
        radial-gradient(980px 400px at 88% 78%, rgba(255,255,255,.05), transparent 75%);
      pointer-events:none;
      opacity:.85;
      transform: translate3d(0,0,0);
      animation: cloudDrift2 62s linear infinite;
      filter: blur(0.4px);
    }

    @keyframes cloudDrift1{
      from { transform: translate3d(0,0,0); }
      to   { transform: translate3d(-220px, 140px, 0); }
    }
    @keyframes cloudDrift2{
      from { transform: translate3d(0,0,0); }
      to   { transform: translate3d(260px, -160px, 0); }
    }

    :root[data-theme="night"] body::before{ opacity:.55; }
    :root[data-theme="night"] body::after{ opacity:.45; }

    .wrap{max-width: 1040px;margin: 28px auto;padding: 0 16px 28px; position:relative}

    :root[data-theme="day"] .wrap::before{
      content:"";
      position:fixed;
      inset:-20%;
      pointer-events:none;
      z-index:-1;
      background:
        radial-gradient(620px 380px at 12% 10%,
          rgba(160,220,255,.22),
          rgba(160,220,255,.10) 42%,
          transparent 72%);
      mix-blend-mode: screen;
      opacity:1;
      transform: translate3d(0,0,0);
    }

    :root[data-theme="night"] .wrap::before{
      content:"";
      position:fixed;
      inset:-25%;
      pointer-events:none;
      z-index:-1;
      background:
        radial-gradient(900px 520px at 78% 18%,
          rgba(90,180,255,.14),
          rgba(90,180,255,.06) 48%,
          transparent 74%),
        radial-gradient(1100px 620px at 30% 85%,
          rgba(80,255,200,.08),
          rgba(80,255,200,.03) 48%,
          transparent 74%);
      opacity:.75;
      mix-blend-mode: screen;
      transform: translate3d(0,0,0);
      animation: auroraDrift 80s ease-in-out infinite alternate;
    }

    @keyframes auroraDrift{
      from { transform: translate3d(-18px, 14px, 0); }
      to   { transform: translate3d(24px, -18px, 0); }
    }

    :root[data-theme="night"] .wrap::after{
      content:"";
      position:fixed;
      inset:-10%;
      pointer-events:none;
      z-index:-1;
      background:
        radial-gradient(2px 2px at 6% 12%, rgba(255,255,255,.90), transparent 60%),
        radial-gradient(1.6px 1.6px at 12% 26%, rgba(255,255,255,.70), transparent 60%),
        radial-gradient(2px 2px at 18% 18%, rgba(255,255,255,.85), transparent 60%),
        radial-gradient(1.4px 1.4px at 22% 40%, rgba(255,255,255,.60), transparent 60%),
        radial-gradient(2.2px 2.2px at 28% 14%, rgba(255,255,255,.95), transparent 60%),
        radial-gradient(1.4px 1.4px at 32% 28%, rgba(255,255,255,.62), transparent 60%),
        radial-gradient(2px 2px at 36% 10%, rgba(255,255,255,.82), transparent 60%),
        radial-gradient(1.6px 1.6px at 40% 22%, rgba(255,255,255,.70), transparent 60%),
        radial-gradient(2px 2px at 44% 16%, rgba(255,255,255,.88), transparent 60%),
        radial-gradient(1.4px 1.4px at 48% 34%, rgba(255,255,255,.58), transparent 60%),
        radial-gradient(2.2px 2.2px at 52% 12%, rgba(255,255,255,.95), transparent 60%),
        radial-gradient(1.4px 1.4px at 56% 26%, rgba(255,255,255,.62), transparent 60%),
        radial-gradient(2px 2px at 60% 18%, rgba(255,255,255,.86), transparent 60%),
        radial-gradient(1.6px 1.6px at 64% 38%, rgba(255,255,255,.68), transparent 60%),
        radial-gradient(2px 2px at 68% 14%, rgba(255,255,255,.90), transparent 60%),
        radial-gradient(1.4px 1.4px at 72% 30%, rgba(255,255,255,.58), transparent 60%),
        radial-gradient(2.4px 2.4px at 76% 18%, rgba(255,255,255,.98), transparent 60%),
        radial-gradient(1.6px 1.6px at 80% 42%, rgba(255,255,255,.70), transparent 60%),
        radial-gradient(2px 2px at 84% 12%, rgba(255,255,255,.88), transparent 60%),
        radial-gradient(1.4px 1.4px at 88% 28%, rgba(255,255,255,.60), transparent 60%),
        radial-gradient(2.2px 2.2px at 92% 18%, rgba(255,255,255,.92), transparent 60%),
        radial-gradient(2px 2px at 10% 70%, rgba(255,255,255,.82), transparent 60%),
        radial-gradient(1.4px 1.4px at 18% 78%, rgba(255,255,255,.58), transparent 60%),
        radial-gradient(2.2px 2.2px at 26% 72%, rgba(255,255,255,.90), transparent 60%),
        radial-gradient(1.4px 1.4px at 34% 86%, rgba(255,255,255,.58), transparent 60%),
        radial-gradient(2px 2px at 42% 76%, rgba(255,255,255,.84), transparent 60%),
        radial-gradient(1.6px 1.6px at 50% 82%, rgba(255,255,255,.66), transparent 60%),
        radial-gradient(2.2px 2.2px at 58% 74%, rgba(255,255,255,.92), transparent 60%),
        radial-gradient(1.4px 1.4px at 66% 88%, rgba(255,255,255,.60), transparent 60%),
        radial-gradient(2px 2px at 74% 76%, rgba(255,255,255,.84), transparent 60%),
        radial-gradient(1.6px 1.6px at 82% 86%, rgba(255,255,255,.68), transparent 60%),
        radial-gradient(2.2px 2.2px at 90% 74%, rgba(255,255,255,.90), transparent 60%),
        radial-gradient(1px 1px at 8% 22%, rgba(255,255,255,.40), transparent 60%),
        radial-gradient(1px 1px at 14% 50%, rgba(255,255,255,.36), transparent 60%),
        radial-gradient(1px 1px at 26% 44%, rgba(255,255,255,.34), transparent 60%),
        radial-gradient(1px 1px at 38% 48%, rgba(255,255,255,.33), transparent 60%),
        radial-gradient(1px 1px at 52% 46%, rgba(255,255,255,.34), transparent 60%),
        radial-gradient(1px 1px at 68% 50%, rgba(255,255,255,.33), transparent 60%),
        radial-gradient(1px 1px at 78% 54%, rgba(255,255,255,.34), transparent 60%),
        radial-gradient(1px 1px at 92% 50%, rgba(255,255,255,.35), transparent 60%);
      opacity:.95;
      transform: translate3d(0,0,0);
      filter: drop-shadow(0 0 4px rgba(255,255,255,.18));
      animation: starDrift 130s linear infinite, starTwinkle 4.6s ease-in-out infinite;
    }

    @keyframes starDrift{
      from { transform: translate3d(0,0,0); }
      to   { transform: translate3d(38px, -28px, 0); }
    }
    @keyframes starTwinkle{
      0%, 100% { opacity:.88; }
      50%      { opacity:1; }
    }

    header{display:flex;gap:14px;align-items:center;justify-content:space-between;margin-bottom:14px}
    .title{display:flex;gap:12px;align-items:center}
    .logo{
      width:44px;height:44px;border-radius:14px;
      display:flex;align-items:center;justify-content:center;
      color: var(--accent2);
      background: linear-gradient(135deg, rgba(14,58,102,1), rgba(30,120,200,1));
      box-shadow:
        0 10px 30px rgba(30,120,200,.45),
        inset 0 0 0 1px rgba(255,255,255,.25);
      flex:0 0 auto;
    }
    .logo svg{width:26px;height:26px}

    h1{margin:0;font-size:26px;font-weight:800;letter-spacing:.6px;line-height:1.1}

    .pillbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 12px;border-radius:999px;
      background: var(--chipBg);
      border:1px solid var(--chipStroke);
      color: var(--muted);
      font-size: 12px;
      backdrop-filter: blur(10px);
      user-select:none;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.45)}
    .dot.good{background:rgba(40,209,124,.9)}
    .dot.bad{background:rgba(255,92,108,.95)}

    /* ‚úÖ bot√≥n volver al landing */
    .homeBtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:14px;
      text-decoration:none;
      color:var(--text);
      background: var(--btnBg);
      border:1px solid var(--btnStroke);
      font-weight:800;
      transition: transform .08s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
    }
    .homeBtn:hover{background: rgba(255,255,255,.12);border-color: rgba(255,255,255,.18)}
    .homeBtn:active{transform: translateY(1px)}

    /* ‚úÖ siempre 1 columna (sin panel derecho) */
    .grid{display:grid;grid-template-columns:1fr;gap:16px}

    @media (max-width: 950px){
      header{flex-direction:column;align-items:flex-start}
      .pillbar{justify-content:flex-start}
    }

    .card{
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .card .inner{padding:16px}

    .totalBox{
      display:flex;align-items:flex-end;justify-content:space-between;gap:14px;
      padding:16px;
      background: linear-gradient(135deg, rgba(30,120,200,.18), rgba(159,212,255,.10));
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .totalLabel{color:var(--muted);font-size:12px;letter-spacing:.2px}
    .totalValue{font-size:30px;font-weight:800;letter-spacing:.6px;font-variant-numeric:tabular-nums}
    .count{color:var(--muted);font-size:12px;margin-top:6px}

    button{
      border:none;cursor:pointer;user-select:none;
      border-radius:14px;padding:10px 12px;
      font-weight:700;letter-spacing:.2px;color:var(--text);
      background: var(--btnBg);
      border:1px solid var(--btnStroke);
      transition: transform .08s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
    }
    button:hover{background: rgba(255,255,255,.12);border-color: rgba(255,255,255,.18)}
    button:active{transform: translateY(1px)}
    button:disabled{opacity:.45;cursor:not-allowed}
    .btnGhost{background: transparent}

    .sortBar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:14px}

    /* === CATEGORIES BAR === */
    #categoryBar{gap:10px}
    .catBtn{
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background: var(--chipBg);
      border:1px solid var(--chipStroke);
      color: var(--text);
      font-weight:800;
      letter-spacing:.2px;
    }
    .catBtn.active{
      background: rgba(255,255,255,.12);
      border-color: rgba(255,255,255,.20);
    }
    .catBtn .mini{opacity:.85}

    .productsGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:14px;
    }
    @media (max-width: 720px){
      .productsGrid{grid-template-columns:1fr}
    }

    .prodCard{
      border-radius:18px;
      overflow:hidden;
      background: rgba(15,45,80,.65);
      border: 1px solid rgba(160,210,255,.18);
      display:flex;flex-direction:column;
      min-height:260px;
      position:relative;
    }
    [data-theme="night"] .prodCard{
      background: rgba(10,22,42,.62);
      border-color: rgba(140,190,255,.14);
    }

    .prodCard.prio{
      border-color: var(--prioStroke);
      box-shadow: 0 0 0 1px var(--prioGlow), 0 20px 60px rgba(0,0,0,.35);
    }

    .prodTop{display:flex;align-items:center;justify-content:space-between;padding:12px 12px 0 12px;gap:10px}

    .prioBadge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border: 1px solid rgba(255,204,102,.35);
      background: var(--prioBg);
      color: var(--prioText);
      font-size:12px;font-weight:800;letter-spacing:.2px;
      user-select:none;
    }

    .pricePill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-variant-numeric:tabular-nums;
      color: rgba(242,246,255,.92);
      font-size:12px;font-weight:800;letter-spacing:.5px;
    }

    .imgBox{
      margin:10px 12px 0;
      height:150px;border-radius:16px;overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      display:flex;align-items:center;justify-content:center;
    }
    .imgBox img{width:100%;height:100%;object-fit:cover;display:block}
    .imgBox .noimg{color:rgba(242,246,255,.55);font-size:12px;text-align:center;padding:6px}

    .prodBody{
      padding:12px;display:flex;flex-direction:column;
      gap:10px;flex:1;min-width:0;
    }
    .prodName{
      font-weight:800;font-size:16px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }

    .prodNotes{
      color: rgba(242,246,255,.72);
      font-size: 12px;
      line-height: 1.35;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .link{
      display:inline-flex;align-items:center;gap:6px;
      color: var(--link);
      text-decoration:none;
      padding:8px 10px;border-radius:14px;
      border:1px solid var(--linkStroke);
      background: var(--linkBg);
      max-width:100%;
      width:fit-content;
    }
    .link:hover{text-decoration:underline}
    .link span{
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      max-width:360px;display:inline-block;vertical-align:bottom;
    }

    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      padding:10px 12px;border-radius:14px;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
      color: rgba(242,246,255,.92);
      font-size:13px;
      opacity:0;pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      backdrop-filter: blur(10px);
      z-index: 9999;
    }
    .toast.show{opacity:1;transform: translateX(-50%) translateY(-2px)}

    /* === MODO CATEGOR√çA (m√°s espacio) === */
    body.inCategory .totalBox{display:none;}
    body.inCategory .pricePill{display:none !important;}

    body.inCategory .productsGrid{
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:14px;
    }
    @media (max-width: 980px){
      body.inCategory .productsGrid{grid-template-columns: repeat(2, minmax(0, 1fr));}
    }
    @media (max-width: 720px){
      body.inCategory .productsGrid{grid-template-columns:1fr;}
    }

    body.inCategory .imgBox{height:190px;}
    body.inCategory .prodCard{min-height:320px;}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <div class="logo" title="Airbus A320">
          <svg viewBox="0 0 64 64" aria-hidden="true">
            <path d="M4 34 L60 32 L60 30 L4 28 Z" fill="currentColor"/>
            <path d="M20 26 L34 14 L36 16 L24 28 Z" fill="currentColor"/>
            <path d="M20 38 L34 50 L36 48 L24 36 Z" fill="currentColor"/>
            <path d="M52 26 L60 20 L60 24 L54 30 Z" fill="currentColor"/>
            <path d="M52 38 L60 44 L60 40 L54 34 Z" fill="currentColor"/>
          </svg>
        </div>
        <div>
          <h1 id="pageTitle">Wishlist</h1>
        </div>
      </div>

      <div class="pillbar">
        <a class="homeBtn" href="/" title="Tornar a l'inici">‚¨ÖÔ∏è Inici</a>
        <button id="themeToggle" title="Canviar mode">üõ´ Dia</button>
        <div class="pill"><span class="dot good"></span> P√∫blic</div>
        <div class="pill"><span id="savedAt">‚Äî</span></div>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="totalBox">
          <div>
            <div class="totalLabel">TOTAL</div>
            <div class="totalValue" id="total">0.00 ‚Ç¨</div>
            <div class="count" id="count">0 elements</div>
          </div>
        </div>

        <div class="inner">
          <div id="categoryBar" class="sortBar"></div>

          <div class="sortBar">
            <button id="sortPrice">‚áÖ Preu</button>
            <button id="sortPrio">‚≠ê Prioritat</button>
          </div>

          <div id="grid" class="productsGrid"></div>
        </div>
      </section>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const $ = (id) => document.getElementById(id);

    let items = [];
    let allItems = [];
    let categories = [];
    let activeCategory = null;

    let sortAscPrice = true;
    let sortAscPrio = false;

    const THEME_KEY = "wishlist_theme_mode_v1";
    let themeMode = localStorage.getItem(THEME_KEY) || "day";

    const Sound = (() => {
      let ctx = null;
      let enabled = true;
      let unlocked = false;

      function ensureCtx(){
        if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
        return ctx;
      }
      function unlock(){
        if (unlocked) return;
        try {
          const c = ensureCtx();
          if (c.state === "suspended") c.resume();
          unlocked = true;
        } catch {}
      }
      function beep({freq=900, dur=0.03, type="sine", gain=0.02}){
        if (!enabled) return;
        let c;
        try { c = ensureCtx(); } catch { return; }
        unlock();

        const o = c.createOscillator();
        const g = c.createGain();

        o.type = type;
        o.frequency.setValueAtTime(freq, c.currentTime);

        g.gain.setValueAtTime(0.0001, c.currentTime);
        g.gain.exponentialRampToValueAtTime(gain, c.currentTime + 0.005);
        g.gain.exponentialRampToValueAtTime(0.0001, c.currentTime + dur);

        o.connect(g);
        g.connect(c.destination);

        o.start();
        o.stop(c.currentTime + dur + 0.01);
      }
      function click(){ beep({freq:1150, dur:0.025, type:"square", gain:0.012}); }
      function toggle(){
        beep({freq:750, dur:0.05, type:"triangle", gain:0.015});
        setTimeout(()=>beep({freq:950, dur:0.04, type:"triangle", gain:0.012}), 45);
      }
      function error(){ beep({freq:320, dur:0.08, type:"sawtooth", gain:0.02}); }
      function bindAutoUnlock(){
        const handler = () => unlock();
        window.addEventListener("pointerdown", handler, {once:true});
        window.addEventListener("keydown", handler, {once:true});
      }
      return { click, toggle, error, bindAutoUnlock };
    })();

    const els = {
      themeToggle: $("themeToggle"),
      grid: $("grid"),
      total: $("total"),
      count: $("count"),
      savedAt: $("savedAt"),
      toast: $("toast"),
      sortPrice: $("sortPrice"),
      sortPrio: $("sortPrio"),
      categoryBar: $("categoryBar"),
      pageTitle: $("pageTitle"),
    };

    function euros(n){ return Number(n||0).toFixed(2) + " ‚Ç¨"; }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, (m)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }

    function safeUrl(url){
      const u = String(url||"").trim();
      if (!u) return "";
      try{
        const parsed = new URL(u);
        if (parsed.protocol === "http:" || parsed.protocol === "https:") return parsed.toString();
        return "";
      } catch { return ""; }
    }

    function showToast(msg){
      els.toast.textContent = msg;
      els.toast.classList.add("show");
      setTimeout(()=>els.toast.classList.remove("show"), 1200);
    }

    function applyTheme(){
      document.documentElement.setAttribute("data-theme", themeMode === "night" ? "night" : "day");
      els.themeToggle.textContent = (themeMode === "night") ? "üåô Nit" : "üõ´ Dia";
      els.themeToggle.title = (themeMode === "night") ? "Mode nit (creuer)" : "Mode dia (desenganxament)";
      localStorage.setItem(THEME_KEY, themeMode);
    }

    function toggleTheme(){
      themeMode = (themeMode === "night") ? "day" : "night";
      applyTheme();
      Sound.toggle();
      showToast(themeMode === "night" ? "Mode nit" : "Mode dia");
    }

    function calcTotal(){
      const len = items.length;
      const total = items.reduce((acc,it)=>acc+Number(it.price||0),0);
      els.total.textContent = euros(total);
      els.count.textContent = `${len} element${len===1?"":"s"}`;
    }

    function render(){
      els.grid.innerHTML = "";

      items.forEach((it)=>{
        const card = document.createElement("div");
        card.className = "prodCard" + (it.priority ? " prio" : "");

        const imgHtml = it.image
          ? `<img src="${escapeHtml(it.image)}" alt="img">`
          : `<div class="noimg">Sense<br>imatge</div>`;

        const cleanLink = safeUrl(it.link);

        const linkHtml = cleanLink
          ? `<a class="link" href="${cleanLink}" target="_blank" rel="noopener noreferrer" title="${escapeHtml(cleanLink)}">
               üîó <span>Ver producto</span>
             </a>`
          : "";

        const prioHtml = it.priority ? `<span class="prioBadge">‚≠ê Prioritari</span>` : "";

        const notesText = String(it.notes || "").trim();
        const notesHtml = notesText
          ? `<div class="prodNotes" title="${escapeHtml(notesText)}">${escapeHtml(notesText)}</div>`
          : "";

        card.innerHTML = `
          <div class="prodTop">
            <div>${prioHtml}</div>
            <div class="pricePill">${euros(it.price)}</div>
          </div>
          <div class="imgBox">${imgHtml}</div>
          <div class="prodBody">
            <div class="prodName" title="${escapeHtml(it.name)}">${escapeHtml(it.name)}</div>
            ${notesHtml}
            ${linkHtml}
          </div>
        `;
        els.grid.appendChild(card);
      });

      calcTotal();
    }

    async function loadCategories(){
      try{
        const r = await fetch("/data/categories.json", { cache: "no-store" });
        const j = await r.json();
        categories = Array.isArray(j.categories) ? j.categories : [];
      } catch {
        categories = [
          { id:"ropa",  name:"Ropa",   icon:"üëï" },
          { id:"setup", name:"Set up", icon:"üñ•Ô∏è" },
          { id:"otros", name:"Otros",  icon:"‚ú®" },
        ];
      }
    }

    function setTitleByCategory(){
      const base = "Wishlist";
      if(!activeCategory){
        els.pageTitle.textContent = base;
        return;
      }
      const c = categories.find(x => x.id === activeCategory);
      const name = c?.name || activeCategory;
      els.pageTitle.textContent = `${base} ¬∑ ${name}`;
    }

    function renderCategoryBar(){
      if(!els.categoryBar) return;

      const btnAll = `
        <button class="catBtn ${activeCategory===null ? "active":""}" data-cat="">
          üóÇÔ∏è <span class="mini">Tot</span>
        </button>
      `;

      const btns = categories.map(c => {
        const isActive = activeCategory === c.id;
        const icon = c.icon || "‚ú®";
        const name = c.name || c.id;
        return `
          <button class="catBtn ${isActive ? "active":""}" data-cat="${escapeHtml(c.id)}">
            ${escapeHtml(icon)} <span>${escapeHtml(name)}</span>
          </button>
        `;
      }).join("");

      els.categoryBar.innerHTML = btnAll + btns;

      els.categoryBar.querySelectorAll("button").forEach(b=>{
        b.addEventListener("click", ()=>{
          const cat = b.getAttribute("data-cat");
          activeCategory = cat ? cat : null;

          document.body.classList.toggle("inCategory", !!activeCategory);

          applyFilterAndRender();
          renderCategoryBar();
          setTitleByCategory();

          showToast(activeCategory ? "Categoria" : "Tot");
          Sound.click();
        });
      });
    }

    function applyFilterAndRender(){
      if(!activeCategory){
        items = [...allItems];
      } else {
        items = allItems.filter(x => (x.category || "otros") === activeCategory);
      }
      render();
    }

    async function loadFromAPI(){
      els.savedAt.textContent = "Carregant...";
      try{
        const res = await fetch("/api/products", { cache: "no-store" });
        if(!res.ok) throw new Error("API " + res.status);
        const data = await res.json();

        allItems = (Array.isArray(data) ? data : [])
          .map(x => ({
            name: String(x.name ?? "").trim(),
            price: Number(x.price ?? 0),
            link: String(x.link ?? ""),
            image: String(x.image ?? ""),
            notes: String(x.notes ?? ""),
            priority: !!x.priority,
            category: String(x.category ?? "otros").trim() || "otros"
          }))
          .filter(x => x.name && Number.isFinite(x.price));

        els.savedAt.textContent = `Publicat ¬∑ ${new Date().toLocaleString()}`;

        applyFilterAndRender();
        setTitleByCategory();
      } catch(e){
        allItems = [];
        items = [];
        render();
        els.savedAt.textContent = "Error carregant";
        showToast("No he pogut carregar /api/products");
        Sound.error();
      }
    }

    function sortByPrice(){
      items.sort((a,b)=> sortAscPrice ? Number(a.price)-Number(b.price) : Number(b.price)-Number(a.price));
      sortAscPrice = !sortAscPrice;
      render();
      showToast("Ordenat per preu");
      Sound.click();
    }

    function sortByPriority(){
      items.sort((a,b)=>{
        const ap=a.priority?1:0, bp=b.priority?1:0;
        return sortAscPrio ? (ap-bp) : (bp-ap);
      });
      sortAscPrio = !sortAscPrio;
      render();
      showToast("Ordenat per prioritat");
      Sound.click();
    }

    Sound.bindAutoUnlock();

    document.addEventListener("click",(e)=>{
      const b=e.target.closest("button");
      if(!b) return;
      const id=b.id||"";
      if(id==="themeToggle") return;
      Sound.click();
    });

    els.themeToggle.addEventListener("click", toggleTheme);
    els.sortPrice.addEventListener("click", sortByPrice);
    els.sortPrio.addEventListener("click", sortByPriority);

    applyTheme();
    (async ()=>{
      await loadCategories();
      renderCategoryBar();
      setTitleByCategory();
      await loadFromAPI();
    })();
  </script>
</body>
</html>
